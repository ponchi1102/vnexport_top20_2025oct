<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vietnam Export Markets 2025-Oct - All 85 Countries</title>
    <style>
        body {
            margin: 0;
            padding: 30px;
            min-height: 20vh;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a192f 0%, #1c3d5a 50%, #2a5478 100%);
            color: #e0e6ed;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .chart-container {
            background: #ffffff;
            border-radius: 20px;
            padding: 48px 60px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25), 0 0 100px rgba(59,130,246,0.15);
            max-width: 1840px;
            width: 100%;
            text-align: center;
            border: 1px solid rgba(59,130,246,0.1);
            position: relative;
        }
        .chart-container::before {
            content: '';
            position: absolute;
            top: -10px; left: -10px; right: -10px; bottom: -10px;
            background: radial-gradient(circle at center, rgba(59,130,246,0.15), transparent 70%);
            border-radius: 18px;
            z-index: -1;
            pointer-events: none;
        }
        h1 {
            font-size: 2.8rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0 0 12px 0;
            letter-spacing: -0.5px;
            background: linear-gradient(90deg, #1e40af, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle {
            color: #64748b;
            font-size: 1.15rem;
            margin-bottom: 40px;
            font-weight: 500;
        }
        .tooltip {
            position: absolute;
            padding: 14px 20px;
            background: rgba(15, 23, 42, 0.96);
            backdrop-filter: blur(12px);
            color: #f8fafc;
            border-radius: 14px;
            border: 1px solid rgba(100, 150, 255, 0.3);
            font-size: 15px;
            line-height: 1.5;
            pointer-events: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4), 0 0 30px rgba(59,130,246,0.2);
            z-index: 1000;
            transform: translateY(-8px);
            transition: all 0.2s ease;
        }
        .tooltip strong {
            color: #60a5fa;
            font-size: 16.5px;
            font-weight: 600;
            display: block;
            margin-bottom: 4px;
        }
        .country-path, .donut-segment {
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .country-path:hover {
            stroke: #ff4d4d !important;
            stroke-width: 3.5 !important;
            filter: drop-shadow(0 0 12px rgba(255,77,77,0.4));
        }
        .donut-segment:hover {
            filter: brightness(1.2) drop-shadow(0 0 15px rgba(255,215,0,0.5));
        }
    </style>
</head>
<body>
    <div class="chart-container">
        <h1>Vietnam Export Markets 2025-Oct</h1>
        <p class="subtitle">All 85 Export Destinations • Top 20 shown in donut • Hover any country on map</p>
        <div id="donut-chart"></div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <script>
        // Full dataset: 85 countries (BigInt → Number)
        const rawData = [
            { code: "US", name: "United States", value: 126166610288n },
            { code: "CN", name: "China", value: 56983749442n },
            { code: "KR", name: "South Korea", value: 23838395230n },
            { code: "JP", name: "Japan", value: 22034460632n },
            { code: "HK", name: "Hong Kong", value: 14328755128n },
            { code: "NL", name: "Netherlands", value: 11026005549n },
            { code: "IN", name: "India", value: 8761303510n },
            { code: "DE", name: "Germany", value: 7781338554n },
            { code: "TH", name: "Thailand", value: 7095934540n },
            { code: "GB", name: "United Kingdom", value: 7044994770n },
            { code: "CA", name: "Canada", value: 6234669225n },
            { code: "MX", name: "Mexico", value: 5791722562n },
            { code: "AU", name: "Australia", value: 5591113106n },
            { code: "TW", name: "Taiwan", value: 5474217749n },
            { code: "AE", name: "UAE", value: 4898685473n },
            { code: "SG", name: "Singapore", value: 4853087449n },
            { code: "ID", name: "Indonesia", value: 4741686686n },
            { code: "KH", name: "Cambodia", value: 4702329749n },
            { code: "PH", name: "Philippines", value: 4658834897n },
            { code: "IT", name: "Italy", value: 4440009752n },
            { code: "MY", name: "Malaysia", value: 4335331436n },
            { code: "ES", name: "Spain", value: 3466685038n },
            { code: "FR", name: "France", value: 3322655434n },
            { code: "BE", name: "Belgium", value: 3018621824n },
            { code: "PL", name: "Poland", value: 2853465741n },
            { code: "AT", name: "Austria", value: 2234169289n },
            { code: "BR", name: "Brazil", value: 2227567036n },
            { code: "RU", name: "Russia", value: 1908237306n },
            { code: "SA", name: "Saudi Arabia", value: 1713440913n },
            { code: "CZ", name: "Czechia", value: 1677128005n },
            { code: "TR", name: "Türkiye", value: 1506370727n },
            { code: "SK", name: "Slovakia", value: 1421445562n },
            { code: "CL", name: "Chile", value: 1252360221n },
            { code: "SE", name: "Sweden", value: 1078404629n },
            { code: "LA", name: "Laos", value: 968420758n },
            { code: "BD", name: "Bangladesh", value: 874922768n },
            { code: "AR", name: "Argentina", value: 801862087n },
            { code: "ZA", name: "South Africa", value: 705223381n },
            { code: "IL", name: "Israel", value: 704336258n },
            { code: "CO", name: "Colombia", value: 698383611n },
            { code: "HU", name: "Hungary", value: 653905989n },
            { code: "IE", name: "Ireland", value: 642231605n },
            { code: "CI", name: "Côte d'Ivoire", value: 594641397n },
            { code: "NZ", name: "New Zealand", value: 593406337n },
            { code: "GH", name: "Ghana", value: 565239786n },
            { code: "PK", name: "Pakistan", value: 527732421n },
            { code: "AM", name: "Armenia", value: 481328709n },
            { code: "PT", name: "Portugal", value: 470534820n },
            { code: "EG", name: "Egypt", value: 466451930n },
            { code: "DZ", name: "Algeria", value: 465077728n },
            { code: "PE", name: "Peru", value: 421938489n },
            { code: "PA", name: "Panama", value: 389004233n },
            { code: "GR", name: "Greece", value: 388746565n },
            { code: "KZ", name: "Kazakhstan", value: 383363770n },
            { code: "RO", name: "Romania", value: 347404231n },
            { code: "DK", name: "Denmark", value: 338702233n },
            { code: "IQ", name: "Iraq", value: 329396540n },
            { code: "SI", name: "Slovenia", value: 305437631n },
            { code: "MM", name: "Myanmar", value: 278934743n },
            { code: "LT", name: "Lithuania", value: 268580410n },
            { code: "LV", name: "Latvia", value: 244359956n },
            { code: "TG", name: "Togo", value: 219977953n },
            { code: "NO", name: "Norway", value: 171519908n },
            { code: "LK", name: "Sri Lanka", value: 162060859n },
            { code: "BN", name: "Brunei", value: 152367129n },
            { code: "CH", name: "Switzerland", value: 150560231n },
            { code: "NG", name: "Nigeria", value: 135644959n },
            { code: "FI", name: "Finland", value: 129885011n },
            { code: "BG", name: "Bulgaria", value: 124152345n },
            { code: "KE", name: "Kenya", value: 101290386n },
            { code: "SN", name: "Senegal", value: 96829865n },
            { code: "LU", name: "Luxembourg", value: 95509339n },
            { code: "MZ", name: "Mozambique", value: 89132838n },
            { code: "UA", name: "Ukraine", value: 78081128n },
            { code: "KW", name: "Kuwait", value: 71676233n },
            { code: "TZ", name: "Tanzania", value: 64585316n },
            { code: "HR", name: "Croatia", value: 60570989n },
            { code: "EE", name: "Estonia", value: 49419980n },
            { code: "CY", name: "Cyprus", value: 47854619n },
            { code: "AO", name: "Angola", value: 43201893n },
            { code: "BY", name: "Belarus", value: 20425003n },
            { code: "MT", name: "Malta", value: 15268541n },
            { code: "TL", name: "Timor-Leste", value: 14156555n },
            { code: "IS", name: "Iceland", value: 6033457n },
            { code: "KG", name: "Kyrgyzstan", value: 5444260n }
        ];

        // Convert BigInt to Number
        const countryData = rawData.map(d => ({
            code: d.code,
            name: d.name,
            value: Number(d.value)
        }));

        // Sort and separate top 10 + others
        countryData.sort((a, b) => b.value - a.value);
        const top10 = countryData.slice(0, 20);
        const others = countryData.slice(20);
        const othersTotal = others.reduce((sum, d) => sum + d.value, 0);

        const donutData = [...top10];
        if (othersTotal > 0) {
            donutData.push({ code: "OTH", name: "All Other Countries (65)", value: othersTotal });
        }

        const totalExport = countryData.reduce((sum, d) => sum + d.value, 0);

        // Full map: code → data for all 85 countries
        const dataByCode = new Map(countryData.map(d => [d.code, d]));

        // ISO Alpha-2 → Numeric ID mapping (for TopoJSON)
        const codeToIdMap = {
            US: 840, CN: 156, KR: 410, JP: 392, HK: 344, NL: 528, IN: 356, DE: 276, TH: 764, GB: 826,
            CA: 124, MX: 484, AU: 36, TW: 158, AE: 784, SG: 702, ID: 360, KH: 116, PH: 608, IT: 380,
            MY: 458, ES: 724, FR: 250, BE: 56, PL: 616, AT: 40, BR: 76, RU: 643, SA: 682, CZ: 203,
            TR: 792, SK: 703, CL: 152, SE: 752, LA: 418, BD: 50, AR: 32, ZA: 710, IL: 376, CO: 170,
            HU: 348, IE: 372, CI: 384, NZ: 554, GH: 288, PK: 586, AM: 51, PT: 620, EG: 818, DZ: 12,
            PE: 604, PA: 591, GR: 300, KZ: 398, RO: 642, DK: 208, IQ: 368, SI: 705, MM: 104, LT: 440,
            LV: 428, TG: 768, NO: 578, LK: 144, BN: 96, CH: 756, NG: 566, FI: 246, BG: 100, KE: 404,
            SN: 686, LU: 442, MZ: 508, UA: 804, KW: 414, TZ: 834, HR: 191, EE: 233, CY: 196, AO: 24,
            BY: 112, MT: 470, TL: 626, IS: 352, KG: 417
        };

        // Dimensions
        const width = 1600;
        const height = 800;
        const radius = Math.min(width, height) / 2;
        const innerRadius = radius * 0.88;

        // SVG Setup
        const svg = d3.select("#donut-chart")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${width / 2}, ${height / 2})`);

        // Clip path for map inside circle
        svg.append("defs")
            .append("clipPath")
            .attr("id", "map-clip")
            .append("circle")
            .attr("cx", 0)
            .attr("cy", 0)
            .attr("r", innerRadius * 0.98);

        // Glow filter
        const glow = svg.append("defs").append("filter").attr("id", "glow");
        glow.append("feGaussianBlur").attr("stdDeviation", 6).attr("result", "blur");
        glow.append("feFlood").attr("flood-color", "#ffd700").attr("result", "flood");
        glow.append("feComposite").attr("in", "flood").attr("in2", "blur").attr("operator", "in");
        glow.append("feMerge").selectAll("feMergeNode")
            .data(["glow", "SourceGraphic"])
            .enter().append("feMergeNode").attr("in", d => d);

        // Color scale
        const color = d3.scaleOrdinal(d3.schemeCategory10.concat(d3.schemeSet3))
            .domain(donutData.map(d => d.code));

        // Pie & Arc
        const pie = d3.pie().value(d => d.value).sort(null);
        const arc = d3.arc().innerRadius(innerRadius).outerRadius(radius);

        // Tooltip
        const tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

        function formatValue(val) {
            return `$${(val / 1e9).toFixed(2)}B`;
        }
        function formatPercent(val) {
            return ((val / totalExport) * 100).toFixed(1) + '%';
        }

        // Highlight function (works for OTH too)
        function highlightCountry(code, on) {
            const isOthers = code === "OTH";
            const segments = isOthers 
                ? d3.selectAll(".donut-segment")
                : d3.selectAll(`.donut-segment[data-country-code="${code}"]`);

            segments.transition().duration(300)
                .attr("fill", on ? d3.color(color(code)).brighter(0.6) : color(code))
                .attr("stroke", on ? "#ffd700" : "#fff")
                .attr("stroke-width", on ? 5 : 2);

            // Highlight countries on map
            if (!isOthers) {
                d3.selectAll(`.country-path[data-country-code="${code}"]`)
                    .transition().duration(300)
                    .attr("fill", on ? "#ff6b6b" : "#a8dadc")
                    .attr("stroke", on ? "#e63946" : "#457b9d")
                    .attr("stroke-width", on ? 3 : 0.5)
                    .style("filter", on ? "url(#glow)" : null);
            }
        }

        // Donut segments
        svg.selectAll(".donut-segment")
            .data(pie(donutData))
            .enter()
            .append("path")
            .attr("class", "donut-segment")
            .attr("data-country-code", d => d.data.code)
            .attr("d", arc)
            .attr("fill", d => color(d.data.code))
            .attr("stroke", "#fff")
            .attr("stroke-width", 2)
            .on("mouseover", (e, d) => {
                const data = d.data;
                tooltip.transition().duration(200).style("opacity", 1);
                tooltip.html(`<strong>${data.name}</strong><br>
                              Export: ${formatValue(data.value)}<br>
                              Share: ${formatPercent(data.value)}`)
                    .style("left", (e.pageX + 15) + "px")
                    .style("top", (e.pageY - 30) + "px");
                highlightCountry(data.code, true);
            })
            .on("mouseout", (_, d) => {
                tooltip.transition().duration(500).style("opacity", 0);
                highlightCountry(d.data.code, false);
            });

        // Map container
        const mapContainer = svg.append("g").attr("clip-path", "url(#map-clip)");

        // Load world map
        d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(world => {
            const countries = topojson.feature(world, world.objects.countries).features;
            const projection = d3.geoMercator().center([0, 15]).translate([0, 0]);
            const path = d3.geoPath().projection(projection);

            projection.fitExtent([[-innerRadius * 0.98, -innerRadius * 0.98], [innerRadius * 0.98, innerRadius * 0.98]], {type: "Sphere"});

            // Graticule
            mapContainer.append("path")
                .datum(d3.geoGraticule10())
                .attr("d", path)
                .attr("fill", "none")
                .attr("stroke", "#ddd")
                .attr("stroke-width", 0.5)
                .attr("opacity", 0.4);

            // Draw all countries
            mapContainer.selectAll(".country-path")
                .data(countries)
                .enter()
                .append("path")
                .attr("class", "country-path")
                .attr("d", path)
                .attr("fill", d => {
                    const code = Object.entries(codeToIdMap).find(([c, id]) => id === Number(d.id))?.[0];
                    return code && dataByCode.has(code) ? "#a8dadc" : "#e0e0e0";
                })
                .attr("stroke", "#457b9d")
                .attr("stroke-width", 0.5)
                .attr("data-country-code", d => {
                    const code = Object.entries(codeToIdMap).find(([c, id]) => id === Number(d.id))?.[0];
                    return code || "";
                })
                .on("mouseover", function(e, d) {
                    const code = this.getAttribute("data-country-code");
                    if (!code || !dataByCode.has(code)) return;

                    const data = dataByCode.get(code);
                    tooltip.transition().duration(200).style("opacity", 1);
                    tooltip.html(`<strong>${data.name}</strong><br>
                                  Export: ${formatValue(data.value)}<br>
                                  Share: ${formatPercent(data.value)}`)
                        .style("left", (e.pageX + 15) + "px")
                        .style("top", (e.pageY - 30) + "px");

                    highlightCountry(code, true);
                })
                .on("mouseout", function() {
                    const code = this.getAttribute("data-country-code");
                    if (code) {
                        tooltip.transition().duration(500).style("opacity", 0);
                        highlightCountry(code, false);
                    }
                });

            // Equator & Prime Meridian
            const lines = [
                {type: "LineString", coordinates: [[-180,0],[180,0]]},
                {type: "LineString", coordinates: [[0,-90],[0,90]]}
            ];
            mapContainer.selectAll(".ref-line")
                .data(lines)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("fill", "none")
                .attr("stroke", "#e63946")
                .attr("stroke-width", 1.2)
                .attr("stroke-dasharray", "6,4")
                .attr("opacity", 0.6);
        });

        // Decorative rings
        svg.append("circle")
            .attr("r", innerRadius * 0.99)
            .attr("fill", "none")
            .attr("stroke", "#1a1a2e")
            .attr("stroke-width", 4)
            .attr("stroke-dasharray", "12,8");

        // Title & Legend (Top 20 + Others)
        svg.append("text")
            .attr("text-anchor", "middle")
            .attr("dy", "-2.2em")
            .style("font-size", "14px")
            .style("font-weight", "bold")
            .style("fill", "#1e293b")
            .text("Vietnam Total Exports to 2025-Oct: $" + (totalExport / 1e9).toFixed(1) + " Billion");

        const legend = svg.append("g")
            .attr("transform", `translate(${radius + 140}, -180)`);

        legend.append("text")
            .attr("y", -15)
            .text("Top 20 + Others")
            .style("font-weight", "bold")
            .style("font-size", "16px")
            .style("fill", "#1e293b");

        legend.selectAll("g")
            .data(donutData)
            .enter()
            .append("g")
            .attr("transform", (d, i) => `translate(0, ${i * 28})`)
            .style("cursor", "pointer")
            .on("mouseover", (e, d) => highlightCountry(d.code, true))
            .on("mouseout", (e, d) => highlightCountry(d.code, false))
            .call(g => g.append("rect")
                .attr("width", 22).attr("height", 22)
                .attr("fill", d => color(d.code))
                .attr("stroke", "#fff").attr("stroke-width", 1.5))
            .call(g => g.append("text")
                .attr("x", 30).attr("y", 16)
                .text(d => d.code === "OTH" ? `${d.name}` : `${donutData.indexOf(d) + 1}. ${d.name}`)
                .style("font-size", "14px")
                .style("fill", "#1e293b"));
    </script>
</body>

</html>
